<include file="Public:header"/>
<script type="text/javascript" src="__PUBLIC__/../Install/js/ajaxForm.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<div class="col-sm-12 widget-container-span">
	<div class="widget-box transparent">
		<div class="widget-header">
			<div class="widget-toolbar no-border">
				<ul class="nav nav-tabs" id="myTab">
					<li class="active"><a data-toggle="tab" href="#home1">旅行プラン新規作成</a></li>
				</ul>
			</div>
		</div>

		<div class="widget-body">
			<div class="widget-main padding-12 no-padding-left no-padding-right">
				<div class="tab-content padding-4">
					<div id="home1" class="tab-pane in active">
						<div class="row">
							<div class="col-xs-12 no-padding-right">
								<form id="groupinfo" action="{:U('Admin/TravelPlan/makeList')}" method="post">
									<div>
										<strong>团号：</strong>
										<strong id="groupname"></strong>
									</div>
									<div class="table-responsive">
										<table width="70%">
											<tbody>
												<tr style="height:10px" />
												<tr>
													<td>
														<label>行程开始日：</label>
													</td>
													<td>
														<input type="date" name="begindate" style="width:150px;" />
													</td>
													<td>
														<label>行程结束日：</label>
													</td>
													<td>
														<input type="date" name="enddate" style="width:150px;" />
													</td>
													<td>
														<label>人数：</label>
													</td>
													<td>
														<input type="text" name="number" \>
													</td>
													<td>
														<label>接机牌：</label>
													</td>
													<td>
														<input type="text" name="flight" \>
													</td>
												</tr>
												<tr>
													<td>
														<label>对方旅行社：</label>
													</td>
													<td>
														<select name="agencyid">
															<option value="0">选择旅行社</option>
															<volist name="agencylist" id="agency">
															<option value="{$agency.id}">{$agency.name}</option>
															</volist>
														</select>
													</td>
													<td>
														<label>对方担当：</label>
													</td>
													<td>
														<select name="agentid">
															<option value="0">选择担当</option>
															<volist name="agentlist" id="agent">
															<option value="{$agent.id}">{$agent.name}</option>
															</volist>
														</select>
													</td>
												</tr>
												<tr>
													<td /><td /><td /><td /><td /><td /><td />
													<td>
														<button type="submit">列表生成</button>
													</td>
												</tr>
												<tr style="height:20px"/>
											</tbody>
										</table>
									</div>
								</form>
								<form id="travelplan" method="post" style="visibility:hidden">
									<div class="table-responsive">
										<table id="maintable" class="table table-striped table-bordered table-hover">
											<thead>
												<tr>
													<th style='width:90px'>日期</th>
													<th style="padding:0px">
														<table id='sample-table-1' class='table table-striped table-bordered table-hover' style='margin-bottom:0px'>
															<thead>
																<tr>
																	<th style='width:100px'>都道府县</th>
																	<th style='width:200px'>景点</th>
																	<th>景点说明</th>
																	<th style='width:50px'>操作</th>
																</tr>
															</thead>
														</table>
													</th>
													<th style="padding:0px">
														<table id='sample-table-1' class='table table-striped table-bordered table-hover' style='margin-bottom:0px'>
															<thead>
																<tr>
																	<th style='width:100px'>都道府县</th>
																	<th style='width:100px'>星级</th>
																	<th>酒店</th>
																	<th style='width:200px'>房间</th>
																	<th style='width:50px'>操作</th>
																</tr>
															</thead>
														</table>
													</th>
													<th>用餐</th>
												</tr>
											</thead>
											<tbody id="entrypoint">
											</tbody>
										</table>
									</div>
									<div class="table-responsive">
										<table width="70%">
											<tbody>
												<tr style="height:20px" />
												<tr>
													<td>
														<label>日本地接报价：</label>
														<input type="text" name="localprice" style="width:100px;" />
														<label>日元/人</label>
													</td>
													<td>
														<label>全程单房差价：</label>
														<input type="text" name="roomprice" style="width:100px;" \>
														<label>日元/间</label>
													</td>
												</tr>
											</tbody>
										</table>
									</div>
									<div class="form-actions">
										<button class="btn btn-primary" type="button" data-toggle="modal" data-target="#confirmsave">保存</button>
										<button class="btn btn-primary" type="button" onclick="print()">PDF</button>
										<button class="btn btn-primary" type="button" onclick="cancel()">FIX</button>
										<a class="btn" href="">取消</a>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="confirmsave" tabindex="-1" role="dialog" aria-labelledby="savediablog" aria-hidden="true">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
		        <h4 class="modal-title" id="savediablog">保存对话框</h4>
		      </div>
		      <div class="modal-body">
		        新建：［細やかな修正で、新しいバージョンとして保存する必要はないため、上書き保存する］
				<br/>
		        更新：［旅の要素が変更したため新しいバージョンとして別に保存する］
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="newTravelList()">新建</button>
		        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="updateTravelList()">更新</button>
		      </div>
		    </div>
		  </div>
		</div>

		<script type="text/javascript">
			function checkForm() {
				var begindate = $('input[name="begindate"]').val()
				var enddate = $('input[name="enddate"]').val()
				var number = $('input[name="number"]').val()
				var flight = $('input[name="flight"]').val()
				var agency = $('select[name="agencyid"]').val()
				var agent = $('select[name="agentid"]').val()
				if (begindate.length != 10 ||
					enddate.length != 10 ||
					number.length <= 0 ||
					flight.length <= 0 ||
					agency.length <= 0 ||
					agent.length <= 0 ||
					agency == "0" ||
					agent == "0") {
					alert("存在空字段或者无效字段！")
					return false
				} else {
					var start = Date.parse(begindate)
					var end = Date.parse(enddate)
					var duration = (end - start) / 1000 / 3600 / 24 + 1
					if (duration > 0) {
						updateTravelPlan(start, end, duration)
					} else {
						alert("日期字段错误！")
						return false
					}
				}
			}
			function makeList(response) {
				$('strong#groupname').text(response.data)
			}
			function updateTravelPlan(start, end, duration) {
				if ($("#travelplan").css("visibility") == "hidden") {
					$("#travelplan").css("visibility", "visible")
				}
				var total = $("#entrypoint").children().size()
				for (var i = duration; duration < total && i < total; i++) {
					$("#entrypoint").children().last().remove()
				}
				for (var i = total; duration > total && i < duration; i++) {
					var rowhtml = "<tr id='mainrow'><td style='padding:5px 0px 5px 5px;vertical-align:middle'></td><td style='padding:0px'><table id='sample-table-1' class='table table-striped table-bordered table-hover' style='margin-bottom:0px'><tbody><tr><td style='padding:0px;width:100px'><select style='width:100%' onchange='getSpotList(this)'><option value='0'>选择地域</option><volist name='citylist' id='city'><option value='{$city.id}'>{$city.name}</option></volist></select></td><td style='padding:0px;width:200px'><select name='spotid[" + i + "][]' style='width:100%'><option value='0'>选择景点</option></select></td><td style='padding:5px 0px 0px 5px'></td><td style='padding:3px 0px 0px 0px;width:50px'><button style='width:50px' onclick='addSpotRow(this)'>添加</button></td></tr></tbody></table></td><td style='padding:0px'><table id='sample-table-1' class='table table-striped table-bordered table-hover' style='margin-bottom:0px'><tbody><tr><td style='padding:0px;width:100px'><select style='width:100%' onchange='changeHotelCity(this)'><option value='0'>选择地域</option><volist name='citylist' id='city'><option value='{$city.id}'>{$city.name}</option></volist></select></td><td style='padding:0px;width:100px'><select style='width:100%' onchange='getHotelList(this)'><option value=''>选择星级</option></select></td><td style='padding:0px'><select name='hotelid[" + i + "][]' style='width:100%' onchange='changeHotelName(this)'><option value='0'>选择酒店</option></select></td><td style='padding:2px 0px 0px 5px;width:200px'>S<input type='text' style='width:50px;border:0px' name='sroom[" + i + "][]' /> T<input type='text' style='width:50px;border:0px' name='troom[" + i + "][]' /> D<input type='text' style='width:50px;border:0px' name='droom[" + i + "][]' /></td><td style='padding:3px 0px 0px 0px;width:50px'><button style='width:50px' onclick='addHotelRow(this)'>添加</button></td></tr></tbody></table></td><td style='padding:2px 0px 2px 0px;text-align:center;vertical-align:middle'>早餐 <select name='breakfast[]'><volist name='foodlist' id='food'><option value='{$food.id}'>{$food.name}</option></volist></select><br />午餐 <select name='lunch[]'><volist name='foodlist' id='food'><option value='{$food.id}'>{$food.name}</option></volist></select><br />晚餐 <select name='dinner[]'><volist name='foodlist' id='food'><option value='{$food.id}'>{$food.name}</option></volist></select></td></tr>"
					$("#entrypoint").append(rowhtml)
				}
				var weekday=new Array(7)
				weekday[0]="周日"
				weekday[1]="周一"
				weekday[2]="周二"
				weekday[3]="周三"
				weekday[4]="周四"
				weekday[5]="周五"
				weekday[6]="周六"
				$("#entrypoint").children().each(function(index, element) {
					var date = new Date(start + index * 24 * 60 * 60 * 1000)
					var str = date.getFullYear() + "/" + (date.getMonth()+1) + "/" + date.getDate()
					$(element).children().eq(0).html("<input type='hidden' name='date[]' value='" + str + "' />" + str + "<br /><input type='hidden' name='week[]' value='" + weekday[date.getDay()] + "' />" + weekday[date.getDay()])
				})
			}
			function addSpotRow(arg) {
				var name = $(arg).parent().prev().prev().children().attr("name")
				var rowhtml = "<tr><td style='padding:0px;width:100px'><select style='width:100%' onchange='getSpotList(this)'><option value='0'>选择地域</option><volist name='citylist' id='city'><option value='{$city.id}'>{$city.name}</option></volist></select></td><td style='padding:0px;width:200px'><select name='" + name + "' style='width:100%'><option value='0'>选择景点</option></select></td><td style='padding:5px 0px 0px 5px'></td><td style='padding:3px 0px 0px 0px;width:50px'><button style='width:50px' onclick='addSpotRow(this)'>添加</button></td></tr>"
				$(arg).parent().parent().parent().append(rowhtml)
				$(arg).parent().html("<button style='width:50px' onclick='delSpotRow(this)'>删除</button>")
			}
			function delSpotRow(arg) {
				$(arg).parent().parent().remove()
			}
			function getSpotList(arg) {
				$(arg).parent().next().children().html("<option value='0'>选择景点</option>")
				$(arg).parent().next().next().html("")
				$(arg).parents("tr#mainrow").children().last().children("input").val("")
				if (arg.value != "0") {
					$.ajax({
						type: "POST",
						url: "{:U('Admin/TravelPlan/getSpotList')}",
						data: "cityid=" + arg.value,
						success: function(response) {
							$.each(response.data, function(i, item) {
								$(arg).parent().next().children().append("<option value='" + item.id + "'>" + item.name + "</option>")
							})
							$(arg).parent().next().children().unbind("change").change(function(){
								var spotselect = $(this)
								spotselect.parent().next().html("")
								$.each(response.data, function(i, item) {
									if (spotselect.val() == item.id) {
										spotselect.parent().next().html(item.description)
										spotselect.parent().next().children().css('margin-bottom', '5px')
									}
								})
							})
						}
					})
				}
			}
			function addHotelRow(arg) {
				var hotelname = $(arg).parent().prev().prev().children().attr("name")
				var sroomname = $(arg).parent().prev().children().eq(0).attr("name")
				var troomname = $(arg).parent().prev().children().eq(1).attr("name")
				var droomname = $(arg).parent().prev().children().eq(2).attr("name")
				var rowhtml = "<tr><td style='padding:0px;width:100px'><select style='width:100%' onchange='changeHotelCity(this)'><option value='0'>选择地域</option><volist name='citylist' id='city'><option value='{$city.id}'>{$city.name}</option></volist></select></td><td style='padding:0px;width:100px'><select style='width:100%' onchange='getHotelList(this)'><option value=''>选择星级</option></select></td><td style='padding:0px'><select name='" + hotelname + "' style='width:100%' onchange='changeHotelName(this)'><option value='0'>选择酒店</option></select></td><td style='padding:2px 0px 0px 5px;width:200px'>S<input type='text' style='width:50px;border:0px' name='" + sroomname + "' /> T<input type='text' style='width:50px;border:0px' name='" + troomname + "' /> D<input type='text' style='width:50px;border:0px' name='" + droomname + "' /></td><td style='padding:3px 0px 0px 0px;width:50px'><button style='width:50px' onclick='addHotelRow(this)'>添加</button></td></tr>"
				$(arg).parent().parent().parent().append(rowhtml)
				$(arg).parent().html("<button style='width:50px' onclick='delHotelRow(this)'>删除</button>")
			}
			function delHotelRow(arg) {
				$(arg).parent().parent().remove()
			}
			function changeHotelCity(arg) {
				$(arg).parent().next().children().html("<option value=''>选择星级</option><volist name='starlist' id='star'><option value='{$key}'>{$star}</option></volist>")
				$(arg).parent().next().next().children().html("<option value='0'>选择酒店</option>")
				$(arg).parent().next().next().next().children("input").val("")
			}
			function getHotelList(arg) {
				$(arg).parent().next().children().html("<option value='0'>选择酒店</option>")
				$(arg).parent().next().next().children("input").val("")
				var cityid = $(arg).parent().prev().children().val()
				if (arg.value != "" && cityid != "0") {
					$.ajax({
						type: "POST",
						url: "{:U('Admin/TravelPlan/getHotelList')}",
						data: "cityid" + cityid + "&starid=" + arg.value,
						success: function(response) {
							$.each(response.data, function(i, item) {
								$(arg).parent().next().children().append("<option value='" + item.id + "'>" + item.name + item.flag + "</option>")
							})
							$(arg).parent().next().children().unbind("change").change(function(){
								$(arg).parent().next().next().children("input").val("")
							})
						}
					})
				}
			}
			function newTravelList() {
				$("#travelplan").attr("action", "{:U('Admin/TravelPlan/savePlan')}")
    			$("#travelplan").submit()
				//alert("newTravelList")
			}
			function updateTravelList() {
				$("#travelplan").attr("action", "{:U('Admin/TravelPlan/savePlan')}")
    			$("#travelplan").submit()
				//alert("updateTravelList")
			}
			function print() {
				alert("print")
			}
			function fix() {
				alert("fix")
			}
			function cancel() {
				alert("cancel")
			}
			$(document).ready(function(){
				$('#groupinfo').ajaxForm({
					beforeSubmit: checkForm,
					success: makeList
				})
			})
		</script>
	</div>
</div>