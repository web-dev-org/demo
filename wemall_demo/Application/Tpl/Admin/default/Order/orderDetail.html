<include file="Public:header"/>
<link href="__PUBLIC__/Plugin/style/css/page.css" type="text/css" rel="stylesheet">	
<style media="print" type="text/css">
     .Noprint
     {
         display: none;
     }
 </style>
<div class="col-sm-12 widget-container-span">
	<div class="widget-box transparent">
		<div class="widget-header">
			<div class="widget-toolbar no-border">
				<ul class="nav nav-tabs" id="myTab">
					<li><a data-toggle="tab" href="#home1">详情</a></li>
				</ul>
			</div>
		</div>
		<div class="widget-body">
			<div class="widget-main padding-12 no-padding-left no-padding-right">
				<div class="tab-content padding-4">
					<div id="home1" class="tab-pane in active">
						<form class="form-horizontal J_ajaxForm" id="myform" action="{:U('Admin/Order/updateorder',array('pageIndex'=>$pageIndex,'orderId'=>$orderId,'tel'=>$tel,'buyTime'=>$buyTime,'states'=>$states,'cityId'=>$cityId))}" method="post" >
							<div class="tabbable">
								<div class="tab-content">
									<div class="tab-pane active">
										<table cellpadding="2" cellspacing="2" width="100%">
											<tbody>
												<tr>
													<td width=50%>支付状态：<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000; font-size:12px;" name="paystatesname" value="{$result.paystatesname}"></td>
													<td>订购单位:<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000; font-size:12px;" name="storename" value="{$result.memstorename}"></td>
												</tr>
												<tr>
													<td id="aaaa">　联系人：<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000; font-size:12px;" name="contacts" value="{$result.memname}"></td>
													<td>　　电话：<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000; font-size:12px;" name="tel" value="{$result.memtel}"></td>
												</tr>
												<tr>
													<td>　　地址：<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000;width:80%; font-size:12px;" name="address" value="{$result.memaddress}"></td>
													<td>订单日期：<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000; font-size:12px;" name="address" value="{$result.buytime}"></td>
												</tr>
												<tr>
													<td>订单金额：<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000; font-size:12px;" name="totalprice" value="{$result.totalprice}">元</td>
													<td>　　数量：<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000; font-size:12px;" name="totalnum" value="{$result.totalnum}"></td>
												</tr>
												<if condition="$result['carfee'] neq '0'">
													<tr>
														<td>　　运费：<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000; font-size:12px;" name="carfee" value="{$result.carfee}">元</td>
														<td>应付金额：<input onfocus=this.blur() type="text" class="input"  style="border:0px; color:#000; font-size:12px;" name="lastprice" value="{$result['totalprice'] + $result['carfee']}">元</td>
													</tr>
												</if>
											</tbody>
										</table>
									</div>
								</div>
							</div>
							
							<div class="form-actions">
								<table cellpadding="2" cellspacing="2" width="100%">
									<tbody>
										<tr>
											<td>
												<input type="hidden" name="orderId" value="{$result.id}">
												<input type="hidden" name="productNum" value="{$count}">
											</td>
											<td width=100>支付状态：</td>
											<td>
												<select name="paystates" class="normal_select">
													<option></option>
													<option value="0" <if condition="$result.paystates eq '0'">selected = "selected"</if>>未支付</option>
													<option value="1" <if condition="$result.paystates eq '1'">selected = "selected"</if>>已支付</option>
												</select>
											
											</td>
											<td width=100>订单状态：</td>
											<td>
												<select name="states" class="normal_select">											
													<option></option>
													<option value="0" <if condition="$result.states eq '0'">selected = "selected"</if>>未发货</option>
													<option value="1" <if condition="$result.states eq '1'">selected = "selected"</if>>已发货</option>
													<option value="2" <if condition="$result.states eq '2'">selected = "selected"</if>>已收货</option>
													<option value="3" <if condition="$result.states eq '3'">selected = "selected"</if>>冻结</option>
												</select>
											</td>
											<td width=100>实收金额：</td>
											<td>	
												<input type="text" class="input" name="actualprice" value="{$result.actualprice}">
											</td>
											<td width=100>费用减免：</td>
											<td>
												<input type="text" class="input" name="minusAmt" value="{$result.minusAmt}">
											</td>
										</tr>
									</tbody>
								</table>
							</div>
							<div class="row">
								<div class="col-xs-12 no-padding-right">
									<div class="table-responsive">
										<table id="sample-table-1"
											class="table table-striped table-bordered table-hover">
											<thead>
												<tr>
													<th>商品名称</th>
													<th>单位</th>
													<th>单价</th>
													<th>购买数量</th>
													<th>配送数量</th>
													<th>备注要求</th>
												</tr>
											</thead>
	
											<tbody>
											<volist name="product" id="vo" key="k">
												<tr>
													<td>{$vo.productname}</td>
													<td>{$vo.unitname}</td>
													<td>{$vo.price}</td>
													<td>{$vo.buyNum}</td>
													<td><input type="text" style="width:60px" id="sendNum_{$k}" name="sendNum_{$k}"  <if condition="$vo['sendNum'] eq ''">value="{$vo.buyNum}" <else /> value="{$vo.sendNum}" </if> onchange="changeNum(this, {$k}, {$vo.buyNum})"></td>
													<td>{$vo.remark}</td>
													<td style="display:none;"><input type="text" id="unitid_{$k}" name="unitid_{$k}" value="{$vo.unitid}" ></td>
													<td style="display:none;"><if condition="$vo['sendNum'] eq ''">{$vo.buyNum} <else /> {$vo.sendNum}</if></td>
													<td style="display:none;">{$vo.lownum}</td>
												</tr>
											</volist>
											</tbody>
										</table>
										<php> if($totalPage > 1) {</php>
											<div class="page_lcb">
												<if condition="$page eq 1">
													<div class="page_up_lcb"><a href="javascript:void(0);">上一页<i><em></em></i></a></div>
												<else/>
													<div class="page_up_lcb"><a href="javascript:void(0);" onclick="changePage({$page - 1},{$count});">上一页<i><em></em></i></a></div>
												</if>
												<if condition="$page eq $totalPage">
													<div class="page_dr_lcb"><a href="javascript:void(0);">下一页<i><em></em></i></a></div>
												<else/>
													<div class="page_dr_lcb"><a href="javascript:void(0);" onclick="changePage({$page + 1},{$count});">下一页<i><em></em></i></a></div>
												</if>
												<div class="page_dr_lcb">
									             	<select id="pageL" name="pageL" onchange="changePage(this.value,{$count});">
									             		<volist name="pageList" id="voFee"> 
									            		    <option value='{$voFee.page}' <if condition="$voFee.page eq $page">selected</if>>{$voFee.page}</option>
									             		</volist>
									             	</select>
												</div>
											</div>
										<php>}else{}</php>   
									</div>
								</div>
							</div>
							<div class="Noprint">
								<button class="btn btn-primary btn_submit J_ajax_submit_btn" type="submit">保存</button>
								<a class="btn" onclick="printOrder()">全部打印</a>
								<a class="btn" href="{:U('Admin/Order/index',array('p'=>$pageIndex,'orderid'=>$orderId,'seTel'=>$tel,'seBuytime'=>$buyTime,'seStates'=>$states,'seCity'=>$cityId))}">返回</a>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
function changeNum(obj, row, oldnum) {
	var sendnum = $('input[name="sendNum_'+row+'"]').val();
	var totalPrice = $('input[name="totalprice"]').val();
	var price = $(obj).parent().prev().prev().html();
	var oldSend = $(obj).parent().next().next().next().html();
	var lownum = $(obj).parent().next().next().next().next().html();
	
	oldSend = parseFloat(oldSend);
	
	if ( isNaN( sendnum )) {
		alert( "配送数量只能输入数字！" );
		$('input[name="sendNum_'+row+'"]').val(oldSend)
		return;
	} else {
		if (sendnum == "") {
			alert( "配送数量不能为空，不配送请填数字0！" );
			$('input[name="sendNum_'+row+'"]').val(oldSend)
			return;
		}
		sendnum = parseFloat(sendnum);
		lownum = parseFloat(lownum);
		
/* 		if ( sendnum != "" && sendnum != "0" && sendnum < lownum ) {
			alert( "配送数量不能小于最低购买量，最低购买量为:" + lownum );
			$('input[name="sendNum_'+row+'"]').val(oldSend)
			return;
		} */
	}
	
	if (oldSend == "") oldSend = 0;
		
	sendnum = parseFloat(sendnum);
	oldnum = parseFloat(oldnum);
	price = parseFloat(price);
	totalPrice = parseFloat(totalPrice);
	
	if ( sendnum != oldSend) {
		if ( sendnum > 0) {
			if ( oldSend > 0 ) {
				totalPrice = totalPrice + price * (sendnum - oldSend);
			} else {
				totalPrice = totalPrice + price * sendnum;
			}
		} else {
			if ( oldSend > 0 ) {
				totalPrice = totalPrice - price * oldSend;
			} else {
				totalPrice = totalPrice - price * oldnum;
			}
		}
		
		totalPrice = Math.round(totalPrice*100)/100;
		$('input[name="totalprice"]').val(totalPrice);
	 	if ( {$result['carfee']} != "0") {
			var lastPrice = totalPrice + parseFloat(carfee);
			lastPrice = Math.round(lastPrice*100)/100;
	 		$('input[name="lastprice"]').val(lastPrice);
		}
		$(obj).parent().next().next().next().html(sendnum);
	}

}

function changePage(curPage, dataNum) {	
	var datalist = new Array();
	var orderId = $('input[name="orderId"]').val();
	var totalprice = $('input[name="totalprice"]').val();
	var paystates = $('select[name="paystates"]').val();
	var states = $('select[name="states"]').val();
	var actualprice = $('input[name="actualprice"]').val();
	var minusAmt = $('input[name="minusAmt"]').val();
		
	var pagedata = new Array();
	var index = 0;
	for ( i=0; i<dataNum; i++ ) {
		index = i + 1;
		datalist = {
				sendNum:$('input[name="sendNum_'+index+'"]').val(),
				unitid:$('input[name="unitid_'+index+'"]').val(),
		}
		pagedata[i] = JSON.stringify(datalist);
	}
	var data = pagedata.join("|");					
	post("{:U('Admin/Order/changePage',array('pageIndex'=>$pageIndex,'orderId'=>$orderId,'tel'=>$tel,'buyTime'=>$buyTime,'states'=>$states,'cityId'=>$cityId))}", {page:curPage,pageData:data,orderId:orderId,dataNum:dataNum,totalPrice:totalprice,paystates:paystates,states:states,actualprice:actualprice,minusAmt:minusAmt});
}

function post(URL, PARAMS) {        
    var temp = document.createElement("form");        
    temp.action = URL;        
    temp.method = "post";        
    temp.style.display = "none";        
    for (var x in PARAMS) {        
        var opt = document.createElement("textarea");        
        opt.name = x;        
        opt.value = PARAMS[x];            
        temp.appendChild(opt);        
    }        
    document.body.appendChild(temp);        
    temp.submit();        
    return temp;        
}

function printOrder()
{
	var isOk = confirm("请先保存后再进行打印，不然填写的数据会丢失！\n 确认打印吗？");
	if (isOk) {
		location.href="{:U('Admin/Order/orderPrint',array('id'=>$result['id'],'pageIndex'=>$pageIndex,'orderId'=>$orderId,'tel'=>$tel,'buyTime'=>$buyTime,'states'=>$states,'cityId'=>$cityId))}";
	}
}
</script>